{% extends "base.html" %}

{% block content %}
<div class="page-header">
    <h2>{% if spot %}Edit Skate Spot{% else %}Add New Skate Spot{% endif %}</h2>
</div>

<form
    id="spot-form"
    {% if spot %}
        hx-put="/api/v1/skate-spots/{{ spot.id }}"
    {% else %}
        hx-post="/api/v1/skate-spots/"
    {% endif %}
    hx-target="#form-container"
    hx-swap="outerHTML"
    hx-encoding="multipart/form-data"
    enctype="multipart/form-data">

    <div id="form-container">
        <div class="form-group">
            <label for="name">Spot Name *</label>
            <input type="text" id="name" name="name" required
                   value="{% if spot %}{{ spot.name }}{% endif %}"
                   maxlength="100">
        </div>

        <div class="form-group">
            <label for="description">Description *</label>
            <textarea id="description" name="description" required
                      maxlength="1000">{% if spot %}{{ spot.description }}{% endif %}</textarea>
        </div>

        <div class="form-group">
            <label for="spot_type">Spot Type *</label>
            <select id="spot_type" name="spot_type" required>
                <option value="">Select a type...</option>
                <option value="street" {% if spot and spot.spot_type == "street" %}selected{% endif %}>Street</option>
                <option value="park" {% if spot and spot.spot_type == "park" %}selected{% endif %}>Park</option>
                <option value="bowl" {% if spot and spot.spot_type == "bowl" %}selected{% endif %}>Bowl</option>
                <option value="vert" {% if spot and spot.spot_type == "vert" %}selected{% endif %}>Vert</option>
                <option value="mini_ramp" {% if spot and spot.spot_type == "mini_ramp" %}selected{% endif %}>Mini Ramp</option>
                <option value="stairs" {% if spot and spot.spot_type == "stairs" %}selected{% endif %}>Stairs</option>
                <option value="rail" {% if spot and spot.spot_type == "rail" %}selected{% endif %}>Rail</option>
                <option value="ledge" {% if spot and spot.spot_type == "ledge" %}selected{% endif %}>Ledge</option>
                <option value="gap" {% if spot and spot.spot_type == "gap" %}selected{% endif %}>Gap</option>
                <option value="other" {% if spot and spot.spot_type == "other" %}selected{% endif %}>Other</option>
            </select>
        </div>

        <div class="form-group">
            <label for="difficulty">Difficulty *</label>
            <select id="difficulty" name="difficulty" required>
                <option value="">Select difficulty...</option>
                <option value="beginner" {% if spot and spot.difficulty == "beginner" %}selected{% endif %}>Beginner</option>
                <option value="intermediate" {% if spot and spot.difficulty == "intermediate" %}selected{% endif %}>Intermediate</option>
                <option value="advanced" {% if spot and spot.difficulty == "advanced" %}selected{% endif %}>Advanced</option>
                <option value="expert" {% if spot and spot.difficulty == "expert" %}selected{% endif %}>Expert</option>
            </select>
        </div>

        <fieldset style="border: 1px solid #ddd; padding: 1rem; border-radius: 4px; margin-bottom: 1.5rem;">
            <legend style="padding: 0 0.5rem; font-weight: 600;">Location</legend>

            <div class="form-group">
                <label for="address-search">Search for a location</label>
                <input type="text" id="address-search" placeholder="Search for an address or place...">
                <div id="search-results" class="search-results"></div>
            </div>

            <div class="form-group">
                <label>Click on the map to select location *</label>
                <div id="location-map" style="height: 400px; width: 100%; border: 1px solid #ddd; border-radius: 4px; margin-bottom: 0.5rem;"></div>
                <small class="form-help">Click on the map to place a marker, or drag the marker to adjust the location.</small>
            </div>

            <div class="location-coords">
                <div class="form-group" style="flex: 1;">
                    <label for="latitude-display">Latitude</label>
                    <input type="text" id="latitude-display" readonly style="background: #f5f5f5;">
                </div>
                <div class="form-group" style="flex: 1;">
                    <label for="longitude-display">Longitude</label>
                    <input type="text" id="longitude-display" readonly style="background: #f5f5f5;">
                </div>
            </div>

            <!-- Hidden inputs for form submission -->
            <input type="hidden" id="latitude" name="latitude" required
                   value="{% if spot %}{{ spot.location.latitude }}{% endif %}">
            <input type="hidden" id="longitude" name="longitude" required
                   value="{% if spot %}{{ spot.location.longitude }}{% endif %}">

            <div class="form-group">
                <label for="city">City *</label>
                <input type="text" id="city" name="city" required
                       value="{% if spot %}{{ spot.location.city }}{% endif %}"
                       placeholder="Auto-filled from map, or enter manually">
            </div>

            <div class="form-group">
                <label for="country">Country *</label>
                <input type="text" id="country" name="country" required
                       value="{% if spot %}{{ spot.location.country }}{% endif %}"
                       placeholder="Auto-filled from map, or enter manually">
            </div>

            <div class="form-group">
                <label for="address">Address (optional)</label>
                <input type="text" id="address" name="address"
                       value="{% if spot and spot.location.address %}{{ spot.location.address }}{% endif %}"
                       placeholder="Auto-filled from map, or enter manually">
            </div>
        </fieldset>

        <div class="form-group checkbox-group">
            <input type="checkbox" id="is_public" name="is_public"
                   {% if not spot or spot.is_public %}checked{% endif %}>
            <label for="is_public" style="margin: 0;">Public spot</label>
        </div>

        <div class="form-group checkbox-group">
            <input type="checkbox" id="requires_permission" name="requires_permission"
                   {% if spot and spot.requires_permission %}checked{% endif %}>
            <label for="requires_permission" style="margin: 0;">Requires permission</label>
        </div>

        <div class="form-group">
            <label for="photo_files">Upload Photos</label>
            <input
                type="file"
                id="photo_files"
                name="photo_files"
                accept="image/*"
                multiple
            >
            <small class="form-help">You can upload multiple images at once. JPEG, PNG, GIF, and WebP are supported.</small>
        </div>

        {% if spot and spot.photos %}
        <div class="existing-photos">
            <h3 class="existing-photos__title">Existing Photos</h3>
            <div class="existing-photos__grid">
                {% for photo in spot.photos %}
                <div class="existing-photos__item">
                    <img src="{{ photo.url }}" alt="Photo of {{ spot.name }}">
                    <label class="existing-photos__checkbox">
                        <input type="checkbox" name="delete_photo_ids" value="{{ photo.id }}">
                        Remove this photo
                    </label>
                    {% if photo.original_filename %}
                    <div class="existing-photos__filename">{{ photo.original_filename }}</div>
                    {% endif %}
                </div>
                {% endfor %}
            </div>
            <small class="form-help">Select the photos you want to remove before uploading new ones.</small>
        </div>
        {% endif %}

        <div class="form-actions">
            <button type="submit" class="btn btn-primary">
                {% if spot %}Update Spot{% else %}Create Spot{% endif %}
            </button>
            <a href="/skate-spots" class="btn btn-secondary">Cancel</a>
        </div>
    </div>
</form>

<style>
.location-coords {
    display: flex;
    gap: 1rem;
}
.search-results {
    position: relative;
    max-height: 300px;
    overflow-y: auto;
    background: white;
    border: 1px solid #ddd;
    border-radius: 4px;
    margin-top: 0.5rem;
    display: none;
}
.search-results.visible {
    display: block;
}
.search-result-item {
    padding: 0.75rem;
    cursor: pointer;
    border-bottom: 1px solid #eee;
}
.search-result-item:hover {
    background: #f5f5f5;
}
.search-result-item:last-child {
    border-bottom: none;
}
</style>

<script>
// Initialize location map
(function() {
    // Constants
    const DEFAULT_MAP_CENTER_LAT = 40.7128;  // New York City
    const DEFAULT_MAP_CENTER_LNG = -74.0060;
    const SEARCH_DEBOUNCE_MS = 300;

    // Default center (will be updated based on existing data or user's first click)
    let defaultLat = {% if spot %}{{ spot.location.latitude }}{% else %}DEFAULT_MAP_CENTER_LAT{% endif %};
    let defaultLng = {% if spot %}{{ spot.location.longitude }}{% else %}DEFAULT_MAP_CENTER_LNG{% endif %};

    const map = L.map('location-map').setView([defaultLat, defaultLng], 13);

    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',
        maxZoom: 19
    }).addTo(map);

    // Custom marker
    let marker = null;

    // Initialize marker if editing existing spot
    {% if spot %}
    marker = L.marker([defaultLat, defaultLng], { draggable: true }).addTo(map);
    updateLocationFields(defaultLat, defaultLng);
    marker.on('dragend', function(e) {
        const pos = e.target.getLatLng();
        updateLocationFields(pos.lat, pos.lng);
        reverseGeocode(pos.lat, pos.lng);
    });
    {% endif %}

    // Handle map clicks
    map.on('click', function(e) {
        const lat = e.latlng.lat;
        const lng = e.latlng.lng;

        if (marker) {
            marker.setLatLng([lat, lng]);
        } else {
            marker = L.marker([lat, lng], { draggable: true }).addTo(map);
            marker.on('dragend', function(e) {
                const pos = e.target.getLatLng();
                updateLocationFields(pos.lat, pos.lng);
                reverseGeocode(pos.lat, pos.lng);
            });
        }

        updateLocationFields(lat, lng);
        reverseGeocode(lat, lng);
    });

    // Update form fields with coordinates
    function updateLocationFields(lat, lng) {
        document.getElementById('latitude').value = lat.toFixed(6);
        document.getElementById('longitude').value = lng.toFixed(6);
        document.getElementById('latitude-display').value = lat.toFixed(6);
        document.getElementById('longitude-display').value = lng.toFixed(6);
    }

    // Reverse geocode to get address info
    function reverseGeocode(lat, lng) {
        fetch(`/api/v1/geocoding/reverse?latitude=${lat}&longitude=${lng}`)
            .then(response => response.json())
            .then(data => {
                if (data.city) {
                    document.getElementById('city').value = data.city;
                }
                if (data.country) {
                    document.getElementById('country').value = data.country;
                }
                if (data.address) {
                    document.getElementById('address').value = data.address;
                }
            })
            .catch(error => {
                console.error('Geocoding error:', error);
            });
    }

    // Address search functionality
    const searchInput = document.getElementById('address-search');
    const searchResults = document.getElementById('search-results');
    let searchTimeout;

    searchInput.addEventListener('input', function(e) {
        const query = e.target.value.trim();

        clearTimeout(searchTimeout);

        if (query.length < 3) {
            searchResults.classList.remove('visible');
            searchResults.innerHTML = '';
            return;
        }

        searchTimeout = setTimeout(() => {
            fetch(`/api/v1/geocoding/search?q=${encodeURIComponent(query)}&limit=5`)
                .then(response => response.json())
                .then(results => {
                    if (results.length === 0) {
                        searchResults.innerHTML = '<div class="search-result-item">No results found</div>';
                        searchResults.classList.add('visible');
                        return;
                    }

                    searchResults.innerHTML = results.map(result => `
                        <div class="search-result-item" data-lat="${result.latitude}" data-lng="${result.longitude}"
                             data-city="${result.city || ''}" data-country="${result.country || ''}"
                             data-address="${result.address || ''}">
                            <strong>${result.address || 'Unknown location'}</strong>
                        </div>
                    `).join('');
                    searchResults.classList.add('visible');

                    // Add click handlers to results
                    document.querySelectorAll('.search-result-item').forEach(item => {
                        item.addEventListener('click', function() {
                            const lat = parseFloat(this.dataset.lat);
                            const lng = parseFloat(this.dataset.lng);
                            const city = this.dataset.city;
                            const country = this.dataset.country;
                            const address = this.dataset.address;

                            // Update map
                            if (marker) {
                                marker.setLatLng([lat, lng]);
                            } else {
                                marker = L.marker([lat, lng], { draggable: true }).addTo(map);
                                marker.on('dragend', function(e) {
                                    const pos = e.target.getLatLng();
                                    updateLocationFields(pos.lat, pos.lng);
                                    reverseGeocode(pos.lat, pos.lng);
                                });
                            }
                            map.setView([lat, lng], 15);

                            // Update fields
                            updateLocationFields(lat, lng);
                            if (city) document.getElementById('city').value = city;
                            if (country) document.getElementById('country').value = country;
                            if (address) document.getElementById('address').value = address;

                            // Clear search
                            searchInput.value = '';
                            searchResults.classList.remove('visible');
                            searchResults.innerHTML = '';
                        });
                    });
                })
                .catch(error => {
                    console.error('Search error:', error);
                    searchResults.innerHTML = '<div class="search-result-item">Error searching. Please try again.</div>';
                    searchResults.classList.add('visible');
                });
        }, SEARCH_DEBOUNCE_MS);
    });

    // Close search results when clicking outside
    document.addEventListener('click', function(e) {
        if (!searchInput.contains(e.target) && !searchResults.contains(e.target)) {
            searchResults.classList.remove('visible');
        }
    });
})();

// Form validation before submission
document.getElementById('spot-form').addEventListener('submit', function(evt) {
    const latitude = document.getElementById('latitude').value;
    const longitude = document.getElementById('longitude').value;

    if (!latitude || !longitude) {
        evt.preventDefault();
        alert('Please select a location on the map before submitting.');
        return false;
    }
});

document.body.addEventListener('htmx:afterRequest', function(evt) {
    if (evt.detail.successful) {
        window.location.href = '/skate-spots';
    }
});
</script>
{% endblock %}
