{% extends "base.html" %}

{% block content %}
<div class="spot-detail-container">
    <div class="spot-detail-header">
        <a href="/skate-spots" class="back-link">‚Üê Back to all spots</a>
    </div>

    <div class="spot-detail">
        <!-- Photo Gallery -->
        {% if spot.photos %}
        <div class="spot-detail-gallery">
            {% for photo in spot.photos %}
            <img src="{{ photo.url }}" alt="Photo of {{ spot.name }}" loading="lazy">
            {% endfor %}
        </div>
        {% else %}
        <div class="spot-detail-gallery-placeholder">
            <span class="placeholder-icon-large">üõπ</span>
            <p>No photos yet</p>
        </div>
        {% endif %}

        <!-- Main Info -->
        <div class="spot-detail-info">
            <div class="spot-detail-title-row">
                <h1>{{ spot.name }}</h1>
                <div class="spot-detail-favorite">
                    {% set is_favorite = spot.id in favorite_spot_ids %}
                    {% with spot_id=spot.id, is_favorite=is_favorite, current_user=current_user %}
                        {% include "partials/favorite_button.html" %}
                    {% endwith %}
                </div>
            </div>

            <div class="spot-detail-meta">
                <span class="badge badge-type">{{ spot.spot_type|format_spot_type }}</span>
                <span class="badge badge-difficulty {{ spot.difficulty }}">{{ spot.difficulty|format_difficulty }}</span>
                {% if spot.is_public %}
                    <span class="badge badge-access">‚úÖ Public</span>
                {% else %}
                    <span class="badge badge-access">üîí Private</span>
                {% endif %}
                {% if spot.requires_permission %}
                    <span class="badge badge-warning">‚ö†Ô∏è Permission required</span>
                {% endif %}
            </div>

            <div class="spot-detail-location">
                <h3>Location</h3>
                <p>üìç {{ spot.location.city }}, {{ spot.location.country }}</p>
                {% if spot.location.address %}
                <p class="spot-detail-address">{{ spot.location.address }}</p>
                {% endif %}
            </div>

            <div class="spot-detail-description">
                <h3>Description</h3>
                <p>{{ spot.description }}</p>
            </div>

            <!-- Action Buttons (if owner or admin) -->
            {% if current_user %}
            <div class="spot-detail-actions">
                {% if current_user.is_admin or is_owner %}
                <a href="/skate-spots/{{ spot.id }}/edit" class="btn btn-edit">Edit Spot</a>
                <button
                    hx-delete="/api/v1/skate-spots/{{ spot.id }}"
                    hx-confirm="Are you sure you want to delete this spot?"
                    hx-target="body"
                    hx-swap="beforeend"
                    class="btn btn-delete">
                    Delete Spot
                </button>
                {% endif %}
            </div>
            {% endif %}
        </div>

        <!-- Interactive Sections with Tabs -->
        <div class="spot-detail-tabs">
            <div class="tab-buttons">
                <button class="tab-button active" data-tab="comments">
                    <span class="tab-icon">üí¨</span>
                    <span class="tab-label">Comments</span>
                    <span class="tab-badge" id="comments-badge"></span>
                </button>
                <button class="tab-button" data-tab="ratings">
                    <span class="tab-icon">‚≠ê</span>
                    <span class="tab-label">Ratings</span>
                    <span class="tab-badge" id="ratings-badge"></span>
                </button>
                <button class="tab-button" data-tab="sessions">
                    <span class="tab-icon">üìÖ</span>
                    <span class="tab-label">Sessions</span>
                    <span class="tab-badge" id="sessions-badge"></span>
                </button>
            </div>

            <!-- Comments Section -->
            <div class="tab-content active" data-tab-content="comments">
                <div
                    class="spot-comments-container"
                    hx-get="/skate-spots/{{ spot.id }}/comments-section"
                    hx-trigger="load"
                    hx-target="this"
                    hx-swap="outerHTML"
                >
                    <div class="section-loading">Loading comments...</div>
                </div>
            </div>

            <!-- Ratings Section -->
            <div class="tab-content" data-tab-content="ratings">
                <div
                    class="spot-rating-container"
                    hx-get="/skate-spots/{{ spot.id }}/rating-section"
                    hx-trigger="revealed"
                    hx-target="this"
                    hx-swap="outerHTML"
                >
                    <div class="section-loading">Loading ratings...</div>
                </div>
            </div>

            <!-- Sessions Section -->
            <div class="tab-content" data-tab-content="sessions">
                <div
                    class="spot-sessions-container"
                    hx-get="/skate-spots/{{ spot.id }}/sessions-section"
                    hx-trigger="revealed"
                    hx-target="this"
                    hx-swap="outerHTML"
                >
                    <div class="section-loading">Loading sessions...</div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
// Enhanced Tab switching functionality with deep linking and badges
(function() {
    const SPOT_ID = '{{ spot.id }}';
    const STORAGE_KEY = `spot-${SPOT_ID}-last-tab`;
    
    // Initialize tab system
    function initTabs() {
        const tabButtons = document.querySelectorAll('.tab-button');
        const tabContents = document.querySelectorAll('.tab-content');
        
        // Function to switch to a specific tab
        function switchToTab(targetTab, updateHistory = true) {
            // Remove active class from all buttons and contents
            tabButtons.forEach(btn => btn.classList.remove('active'));
            tabContents.forEach(content => content.classList.remove('active'));
            
            // Add active class to target button and content
            const targetButton = document.querySelector(`[data-tab="${targetTab}"]`);
            const targetContent = document.querySelector(`[data-tab-content="${targetTab}"]`);
            
            if (targetButton && targetContent) {
                targetButton.classList.add('active');
                targetContent.classList.add('active');
                
                // Update URL hash without scrolling
                if (updateHistory) {
                    history.replaceState(null, null, `#${targetTab}`);
                }
                
                // Save to localStorage
                try {
                    localStorage.setItem(STORAGE_KEY, targetTab);
                } catch (e) {
                    // localStorage might not be available
                }
                
                // Trigger HTMX load for tabs that use 'revealed' trigger
                const htmxElement = targetContent.querySelector('[hx-trigger="revealed"]');
                if (htmxElement && !htmxElement.classList.contains('htmx-loaded')) {
                    htmx.trigger(htmxElement, 'revealed');
                    htmxElement.classList.add('htmx-loaded');
                }
            }
        }
        
        // Click handlers for tab buttons
        tabButtons.forEach(button => {
            button.addEventListener('click', function() {
                const targetTab = this.getAttribute('data-tab');
                switchToTab(targetTab);
            });
        });
        
        // Deep linking: Check URL hash on load
        function initializeActiveTab() {
            const hash = window.location.hash.slice(1); // Remove the #
            const validTabs = ['comments', 'ratings', 'sessions'];
            
            if (hash && validTabs.includes(hash)) {
                // URL hash takes precedence
                switchToTab(hash, false);
            } else {
                // Try localStorage
                try {
                    const lastTab = localStorage.getItem(STORAGE_KEY);
                    if (lastTab && validTabs.includes(lastTab)) {
                        switchToTab(lastTab, false);
                        return;
                    }
                } catch (e) {
                    // localStorage not available
                }
                
                // Default to comments and update hash
                switchToTab('comments', false);
            }
        }
        
        // Handle browser back/forward with hash changes
        window.addEventListener('hashchange', function() {
            const hash = window.location.hash.slice(1);
            const validTabs = ['comments', 'ratings', 'sessions'];
            if (hash && validTabs.includes(hash)) {
                switchToTab(hash, false);
            }
        });
        
        // Initialize the active tab
        initializeActiveTab();
        
        // Update badges after HTMX loads content
        updateBadges();
    }
    
    // Function to update badge counts
    function updateBadges() {
        // Use setTimeout to wait for HTMX content to load
        setTimeout(() => {
            // Comments badge
            const comments = document.querySelectorAll('#comment-section-{{ spot.id }} .comment-item');
            updateBadge('comments-badge', comments.length);
            
            // Ratings badge
            const ratingSummary = document.querySelector('#rating-section-{{ spot.id }} .rating-summary');
            if (ratingSummary) {
                const ratingText = ratingSummary.textContent;
                const match = ratingText.match(/(\d+)\s+rating/);
                if (match) {
                    updateBadge('ratings-badge', parseInt(match[1]));
                }
            }
            
            // Sessions badge
            const sessions = document.querySelectorAll('#session-section-{{ spot.id }} .session-card');
            updateBadge('sessions-badge', sessions.length);
        }, 500);
    }
    
    function updateBadge(badgeId, count) {
        const badge = document.getElementById(badgeId);
        if (badge && count > 0) {
            badge.textContent = count;
            badge.classList.add('visible');
        }
    }
    
    // Listen for HTMX events to update badges when content loads
    document.addEventListener('htmx:afterSwap', function() {
        updateBadges();
    });
    
    // Initialize when DOM is ready
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', initTabs);
    } else {
        initTabs();
    }
})();
</script>
{% endblock %}
