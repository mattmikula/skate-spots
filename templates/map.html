{% extends "base.html" %}

{% block title %}Map - Skate Spots{% endblock %}

{% block content %}
<div class="page-header">
    <h2>Skate Spots Map</h2>
    <a href="/skate-spots/new" class="btn btn-primary">+ Add New Spot</a>
</div>

<div id="map"></div>

<script>
    // Initialize the map centered on a default location
    const map = L.map('map').setView([40.7128, -74.0060], 10);

    // Add OpenStreetMap tile layer
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',
        maxZoom: 19
    }).addTo(map);

    // Custom icon for skate spots
    const skateIcon = L.divIcon({
        html: 'ðŸ›¹',
        className: 'skate-marker',
        iconSize: [30, 30],
        iconAnchor: [15, 15],
        popupAnchor: [0, -15]
    });

    // Difficulty color mapping
    const difficultyColors = {
        'beginner': '#2ecc71',
        'intermediate': '#f39c12',
        'advanced': '#e67e22',
        'expert': '#e74c3c'
    };

    // Fetch spots data and add markers
    fetch('/api/v1/skate-spots/geojson')
        .then(response => response.json())
        .then(data => {
            if (data.features && data.features.length > 0) {
                // Add GeoJSON layer
                const spotsLayer = L.geoJSON(data, {
                    pointToLayer: (feature, latlng) => {
                        return L.marker(latlng, { icon: skateIcon });
                    },
                    onEachFeature: (feature, layer) => {
                        const props = feature.properties;
                        const difficultyColor = difficultyColors[props.difficulty] || '#95a5a6';

                        const popupContent = `
                            <div class="map-popup">
                                <h3>${props.name}</h3>
                                <p>${props.description}</p>
                                <div class="spot-meta">
                                    <span class="badge badge-type">${props.spot_type}</span>
                                    <span class="badge badge-difficulty ${props.difficulty}" style="background: ${difficultyColor}">${props.difficulty}</span>
                                </div>
                                <p><strong>Location:</strong> ${props.city}, ${props.country}</p>
                                ${props.address ? `<p><strong>Address:</strong> ${props.address}</p>` : ''}
                                <div class="spot-actions" style="margin-top: 1rem;">
                                    <a href="/skate-spots/${props.id}/edit" class="btn btn-edit btn-sm">Edit</a>
                                    <button
                                        hx-delete="/api/v1/skate-spots/${props.id}"
                                        hx-confirm="Are you sure you want to delete this spot?"
                                        hx-target="closest .leaflet-popup"
                                        hx-swap="outerHTML"
                                        class="btn btn-delete btn-sm"
                                    >Delete</button>
                                </div>
                            </div>
                        `;

                        layer.bindPopup(popupContent, {
                            maxWidth: 300,
                            className: 'spot-popup'
                        });
                    }
                }).addTo(map);

                // Fit map to show all markers
                map.fitBounds(spotsLayer.getBounds(), { padding: [50, 50] });
            } else {
                // No spots, show message
                const noSpotsMessage = L.control({ position: 'topright' });
                noSpotsMessage.onAdd = function() {
                    const div = L.DomUtil.create('div', 'map-message');
                    div.innerHTML = '<p>No skate spots yet. <a href="/skate-spots/new">Add the first one!</a></p>';
                    return div;
                };
                noSpotsMessage.addTo(map);
            }
        })
        .catch(error => {
            console.error('Error loading spots:', error);
        });
</script>
{% endblock %}
