{% extends "spots/base.html" %}

{% block content %}
<div class="page-header">
    <h2>{% if spot %}Edit Skate Spot{% else %}Add New Skate Spot{% endif %}</h2>
</div>

<form
    {% if spot %}
        hx-put="/api/v1/skate-spots/{{ spot.id }}/"
    {% else %}
        hx-post="/api/v1/skate-spots/"
    {% endif %}
    hx-target="#form-container"
    hx-swap="outerHTML"
    hx-ext="json-enc"
    hx-headers='{"X-CSRFToken": "{{ csrf_token }}"}'>

    <div id="form-container">
        <div class="form-group">
            <label for="name">Spot Name *</label>
            <input type="text" id="name" name="name" required
                   value="{% if spot %}{{ spot.name }}{% endif %}"
                   maxlength="100">
        </div>

        <div class="form-group">
            <label for="description">Description *</label>
            <textarea id="description" name="description" required
                      maxlength="1000">{% if spot %}{{ spot.description }}{% endif %}</textarea>
        </div>

        <div class="form-group">
            <label for="spot_type">Spot Type *</label>
            <select id="spot_type" name="spot_type" required>
                <option value="">Select a type...</option>
                <option value="street" {% if spot and spot.spot_type == "street" %}selected{% endif %}>Street</option>
                <option value="park" {% if spot and spot.spot_type == "park" %}selected{% endif %}>Park</option>
                <option value="bowl" {% if spot and spot.spot_type == "bowl" %}selected{% endif %}>Bowl</option>
                <option value="vert" {% if spot and spot.spot_type == "vert" %}selected{% endif %}>Vert</option>
                <option value="mini_ramp" {% if spot and spot.spot_type == "mini_ramp" %}selected{% endif %}>Mini Ramp</option>
                <option value="stairs" {% if spot and spot.spot_type == "stairs" %}selected{% endif %}>Stairs</option>
                <option value="rail" {% if spot and spot.spot_type == "rail" %}selected{% endif %}>Rail</option>
                <option value="ledge" {% if spot and spot.spot_type == "ledge" %}selected{% endif %}>Ledge</option>
                <option value="gap" {% if spot and spot.spot_type == "gap" %}selected{% endif %}>Gap</option>
                <option value="other" {% if spot and spot.spot_type == "other" %}selected{% endif %}>Other</option>
            </select>
        </div>

        <div class="form-group">
            <label for="difficulty">Difficulty *</label>
            <select id="difficulty" name="difficulty" required>
                <option value="">Select difficulty...</option>
                <option value="beginner" {% if spot and spot.difficulty == "beginner" %}selected{% endif %}>Beginner</option>
                <option value="intermediate" {% if spot and spot.difficulty == "intermediate" %}selected{% endif %}>Intermediate</option>
                <option value="advanced" {% if spot and spot.difficulty == "advanced" %}selected{% endif %}>Advanced</option>
                <option value="expert" {% if spot and spot.difficulty == "expert" %}selected{% endif %}>Expert</option>
            </select>
        </div>

        <fieldset style="border: 1px solid #ddd; padding: 1rem; border-radius: 4px; margin-bottom: 1.5rem;">
            <legend style="padding: 0 0.5rem; font-weight: 600;">Location</legend>

            <div class="location-fields">
                <div class="form-group">
                    <label for="latitude">Latitude *</label>
                    <input type="number" id="latitude" name="latitude" step="any" required
                           value="{% if spot %}{{ spot.latitude }}{% endif %}"
                           min="-90" max="90">
                </div>

                <div class="form-group">
                    <label for="longitude">Longitude *</label>
                    <input type="number" id="longitude" name="longitude" step="any" required
                           value="{% if spot %}{{ spot.longitude }}{% endif %}"
                           min="-180" max="180">
                </div>
            </div>

            <div class="form-group">
                <label for="city">City *</label>
                <input type="text" id="city" name="city" required
                       value="{% if spot %}{{ spot.city }}{% endif %}">
            </div>

            <div class="form-group">
                <label for="country">Country *</label>
                <input type="text" id="country" name="country" required
                       value="{% if spot %}{{ spot.country }}{% endif %}">
            </div>

            <div class="form-group">
                <label for="address">Address (optional)</label>
                <input type="text" id="address" name="address"
                       value="{% if spot and spot.address %}{{ spot.address }}{% endif %}">
            </div>
        </fieldset>

        <div class="form-group checkbox-group">
            <input type="checkbox" id="is_public" name="is_public"
                   {% if not spot or spot.is_public %}checked{% endif %}>
            <label for="is_public" style="margin: 0;">Public spot</label>
        </div>

        <div class="form-group checkbox-group">
            <input type="checkbox" id="requires_permission" name="requires_permission"
                   {% if spot and spot.requires_permission %}checked{% endif %}>
            <label for="requires_permission" style="margin: 0;">Requires permission</label>
        </div>

        <div class="form-actions">
            <button type="submit" class="btn btn-primary" hx-indicator="#loading-spinner">
                <span class="button-text">{% if spot %}Update Spot{% else %}Create Spot{% endif %}</span>
                <span id="loading-spinner" class="htmx-indicator"> Saving...</span>
            </button>
            <a href="{% url 'list_spots' %}" class="btn btn-secondary">Cancel</a>
        </div>
    </div>
</form>

<style>
/* Disable button during HTMX request */
button.htmx-request {
    opacity: 0.6;
    pointer-events: none;
}

.htmx-indicator {
    display: none;
}

.htmx-request .htmx-indicator {
    display: inline;
}

.htmx-request .button-text {
    display: none;
}
</style>

<script>
// Handle successful submission
document.body.addEventListener('htmx:afterRequest', function(evt) {
    const form = evt.detail.elt;

    // Only handle our form submissions
    if (form.tagName === 'FORM' && evt.detail.successful) {
        // Prevent any flash by immediately navigating
        window.location.replace('{% url "list_spots" %}');
    } else if (form.tagName === 'FORM' && !evt.detail.successful) {
        // Show error message if request failed
        const response = evt.detail.xhr.responseText;
        try {
            const error = JSON.parse(response);
            let errorMsg = 'Error saving spot:\n';
            for (const [field, messages] of Object.entries(error)) {
                if (Array.isArray(messages)) {
                    errorMsg += `${field}: ${messages.join(', ')}\n`;
                } else {
                    errorMsg += `${field}: ${messages}\n`;
                }
            }
            alert(errorMsg);
        } catch (e) {
            alert('Error: Failed to save spot. Please try again.');
        }
    }
});
</script>
{% endblock %}
