{% extends "base.html" %}

{% block title %}Find Nearby Spots - Skate Spots{% endblock %}

{% block content %}
<div class="page-header">
    <h2>Find Nearby Spots</h2>
    <a href="/skate-spots/new" class="btn btn-primary">+ Add New Spot</a>
</div>

<div class="nearby-container">
    <!-- Location Input Section -->
    <div class="location-input-section">
        <div class="location-card">
            <h3>Search Location</h3>

            <div class="location-buttons">
                <button id="use-my-location" class="btn btn-primary btn-large">
                    <span aria-hidden="true">üìç</span> Use My Location
                </button>
                <span id="location-status" class="location-status"></span>
            </div>

            <div class="location-divider">or</div>

            <form id="location-form" class="location-form" method="get" action="/nearby">
                <div id="form-error" class="location-status error" style="display: none;" role="alert" aria-live="polite"></div>

                <div class="form-group">
                    <label for="location-query">Search by place</label>
                    <input
                        type="search"
                        id="location-query"
                        name="location"
                        value="{{ location_query or '' }}"
                        placeholder="City, address, or zip (e.g. Barcelona or 90210)"
                        autocomplete="off"
                        aria-describedby="location-query-help"
                    >
                    <p id="location-query-help" class="form-help">We'll geocode this if you don't have coordinates.</p>
                    <div id="location-results" class="location-search-results" role="listbox" aria-live="polite"></div>
                </div>

                <div class="form-group">
                    <label for="manual-latitude">Latitude</label>
                    <input
                        type="number"
                        id="manual-latitude"
                        name="latitude"
                        placeholder="-90 to 90"
                        min="-90"
                        max="90"
                        step="0.0001"
                        value="{{ latitude | default('', true) }}"
                        aria-required="true"
                    >
                </div>

                <div class="form-group">
                    <label for="manual-longitude">Longitude</label>
                    <input
                        type="number"
                        id="manual-longitude"
                        name="longitude"
                        placeholder="-180 to 180"
                        min="-180"
                        max="180"
                        step="0.0001"
                        value="{{ longitude | default('', true) }}"
                        aria-required="true"
                    >
                </div>

                <div class="form-group">
                    <label for="radius-slider">Search Radius: <span id="radius-display">5</span> km</label>
                    <input
                        type="range"
                        id="radius-slider"
                        name="radius_km"
                        min="1"
                        max="50"
                        value="{{ radius_km | default(5, true) }}"
                        class="radius-slider"
                    >
                    <div class="radius-info">1 km - 50 km</div>
                </div>

                <button type="submit" class="btn btn-primary">Search Nearby Spots</button>
            </form>
        </div>
    </div>

    <!-- Results Section (shown only when location is provided) -->
    {% if latitude is defined and latitude is not none %}
    <div class="nearby-results">
        <div class="results-header">
            <h3>Spots within {{ radius_km }} km</h3>
            <p class="location-coordinates">
                üìç
                {% if resolved_location_label %}
                    {{ resolved_location_label }} <span class="coordinates-inline">({{ latitude | round(4) }}, {{ longitude | round(4) }})</span>
                {% else %}
                    {{ latitude | round(4) }}, {{ longitude | round(4) }}
                {% endif %}
            </p>
        </div>

        <!-- Filters Form -->
        <form
            id="nearby-filter-form"
            class="filter-form"
            hx-get="/nearby"
            hx-target="#nearby-spot-results"
            hx-push-url="true"
            hx-trigger="submit, change delay:300ms from:select, keyup changed delay:500ms from:input"
            hx-indicator="#nearby-filter-indicator"
        >
            <!-- Hidden location fields -->
            <input type="hidden" name="latitude" value="{{ latitude }}">
            <input type="hidden" name="longitude" value="{{ longitude }}">
            <input type="hidden" name="radius_km" value="{{ radius_km }}">
            <input type="hidden" name="location" value="{{ location_query or '' }}">

            <div class="filter-grid">
                <div class="filter-field">
                    <label for="filter-search">Search</label>
                    <input
                        type="search"
                        id="filter-search"
                        name="search"
                        value="{{ filter_values.get('search', '') }}"
                        placeholder="Search by name or description"
                    >
                </div>

                <div class="filter-field">
                    <label for="filter-spot-type">Spot type</label>
                    <select id="filter-spot-type" name="spot_type">
                        <option value="">Any type</option>
                        {% for option in spot_types %}
                        <option
                            value="{{ option.value }}"
                            {% if filter_values.get('spot_type') == option.value %}selected{% endif %}
                        >{{ option.value | replace('_', ' ') | title }}</option>
                        {% endfor %}
                    </select>
                </div>

                <div class="filter-field">
                    <label for="filter-difficulty">Difficulty</label>
                    <select id="filter-difficulty" name="difficulty">
                        <option value="">Any level</option>
                        {% for option in difficulties %}
                        <option
                            value="{{ option.value }}"
                            {% if filter_values.get('difficulty') == option.value %}selected{% endif %}
                        >{{ option.value | title }}</option>
                        {% endfor %}
                    </select>
                </div>

                <div class="filter-field">
                    <label for="filter-city">City</label>
                    <input
                        type="text"
                        id="filter-city"
                        name="city"
                        value="{{ filter_values.get('city', '') }}"
                        placeholder="e.g. Barcelona"
                    >
                </div>
            </div>

            <div class="filter-actions">
                <button type="submit" class="btn btn-primary">Apply filters</button>
                {% if has_active_filters %}
                <a
                    href="/nearby?latitude={{ latitude }}&longitude={{ longitude }}&radius_km={{ radius_km }}{% if location_query %}&location={{ location_query | urlencode }}{% endif %}"
                    class="btn btn-secondary"
                >Clear filters</a>
                {% endif %}
                <span id="nearby-filter-indicator" class="htmx-indicator" role="status" aria-live="polite">
                    Updating spots‚Ä¶
                </span>
            </div>
        </form>

        <!-- Results List -->
        <div id="nearby-spot-results">
            {% include "partials/nearby_spot_list.html" %}
        </div>
    </div>
    {% endif %}
</div>

<script>
(function() {
    const form = document.getElementById('location-form');
    const latInput = document.getElementById('manual-latitude');
    const lngInput = document.getElementById('manual-longitude');
    const locationInput = document.getElementById('location-query');
    const resultsList = document.getElementById('location-results');
    const statusEl = document.getElementById('location-status');
    const errorEl = document.getElementById('form-error');
    const useLocationBtn = document.getElementById('use-my-location');
    const radiusSlider = document.getElementById('radius-slider');
    const radiusDisplay = document.getElementById('radius-display');
    const LAST_LOCATION_KEY = 'skate-spots:last-location';
    let searchTimeout;

    const updateRadiusDisplay = () => {
        radiusDisplay.textContent = radiusSlider.value;
    };
    updateRadiusDisplay();

    function persistLocation(lat, lng, label) {
        try {
            localStorage.setItem(
                LAST_LOCATION_KEY,
                JSON.stringify({ lat, lng, label })
            );
        } catch (err) {
            // Ignore storage failures
        }
    }

    function restoreLocation() {
        if (latInput.value || lngInput.value) {
            return;
        }
        try {
            const raw = localStorage.getItem(LAST_LOCATION_KEY);
            if (!raw) {
                return;
            }
            const saved = JSON.parse(raw);
            if (!saved.lat || !saved.lng) {
                return;
            }
            latInput.value = saved.lat;
            lngInput.value = saved.lng;
            statusEl.textContent = saved.label
                ? `Using saved location: ${saved.label}`
                : 'Using saved location';
            statusEl.className = 'location-status success';
        } catch (err) {
            // Ignore parse failures
        }
    }
    restoreLocation();

    function clearResults() {
        resultsList.innerHTML = '';
        resultsList.classList.remove('visible');
    }

    function buildSearchUrl() {
        const params = new URLSearchParams(new FormData(form));
        return `/nearby?${params.toString()}`;
    }

    function redirectWithForm() {
        window.location.href = buildSearchUrl();
    }

    function applyCoordinates(lat, lng, label, shouldNavigate = true) {
        latInput.value = Number(lat).toFixed(6);
        lngInput.value = Number(lng).toFixed(6);
        if (locationInput && label) {
            locationInput.value = label;
        }
        statusEl.textContent = `‚úÖ Using ${label || 'selected location'}`;
        statusEl.className = 'location-status success';
        persistLocation(latInput.value, lngInput.value, label || null);
        if (shouldNavigate) {
            redirectWithForm();
        }
    }

    // Handle "Use My Location" button
    useLocationBtn.addEventListener('click', function() {
        if (!navigator.geolocation) {
            statusEl.textContent = '‚ùå Geolocation not supported';
            statusEl.className = 'location-status error';
            return;
        }

        useLocationBtn.disabled = true;
        statusEl.textContent = 'üîç Getting location...';
        statusEl.className = 'location-status loading';

        navigator.geolocation.getCurrentPosition(
            function(position) {
                const lat = position.coords.latitude;
                const lng = position.coords.longitude;
                applyCoordinates(lat, lng, 'current location');
            },
            function(error) {
                useLocationBtn.disabled = false;
                let message = '‚ùå ';
                if (error.code === 1) {
                    message += 'Permission denied. Please enable location access.';
                } else if (error.code === 2) {
                    message += 'Location unavailable. Try manual search.';
                } else if (error.code === 3) {
                    message += 'Location request timed out.';
                } else {
                    message += 'Error getting location.';
                }
                statusEl.textContent = message;
                statusEl.className = 'location-status error';
            },
            { timeout: 10000 }
        );
    });

    // Update radius display
    radiusSlider.addEventListener('input', updateRadiusDisplay);

    function renderLocationResults(results, query) {
        resultsList.innerHTML = '';
        resultsList.classList.add('visible');

        if (!results.length) {
            const empty = document.createElement('div');
            empty.className = 'location-result muted';
            empty.textContent = 'No matches. Try a nearby city or postcode.';
            resultsList.appendChild(empty);
            return;
        }

        results.forEach((result) => {
            const button = document.createElement('button');
            button.type = 'button';
            button.className = 'location-result';
            const label =
                result.address ||
                [result.city, result.country].filter(Boolean).join(', ') ||
                query;
            button.dataset.lat = result.latitude;
            button.dataset.lng = result.longitude;
            button.dataset.label = label;

            const title = document.createElement('div');
            title.className = 'location-result__title';
            title.textContent = label;

            const meta = document.createElement('div');
            meta.className = 'location-result__meta';
            meta.textContent = `${Number(result.latitude).toFixed(4)}, ${Number(
                result.longitude
            ).toFixed(4)}`;

            button.appendChild(title);
            button.appendChild(meta);
            button.addEventListener('click', () => {
                clearResults();
                applyCoordinates(result.latitude, result.longitude, label);
            });
            resultsList.appendChild(button);
        });
    }

    if (locationInput) {
        locationInput.addEventListener('input', () => {
            clearTimeout(searchTimeout);
            const query = locationInput.value.trim();

            if (!query || query.length < 3) {
                clearResults();
                return;
            }

            searchTimeout = setTimeout(async () => {
                resultsList.innerHTML =
                    '<div class="location-result muted">Searching‚Ä¶</div>';
                resultsList.classList.add('visible');
                try {
                    const response = await fetch(
                        `/api/v1/geocoding/search?q=${encodeURIComponent(
                            query
                        )}&limit=5`
                    );
                    if (!response.ok) {
                        throw new Error('Search failed');
                    }
                    const results = await response.json();
                    renderLocationResults(results, query);
                } catch (err) {
                    resultsList.innerHTML =
                        '<div class="location-result error">Error searching. Please try again.</div>';
                    resultsList.classList.add('visible');
                }
            }, 350);
        });
    }

    document.addEventListener('click', (event) => {
        if (
            !locationInput.contains(event.target) &&
            !resultsList.contains(event.target)
        ) {
            clearResults();
        }
    });

    // Handle manual location form submission
    form.addEventListener('submit', function(e) {
        const hasCoords = latInput.value && lngInput.value;
        const hasQuery = locationInput.value.trim().length > 0;

        if (!hasCoords && !hasQuery) {
            e.preventDefault();
            errorEl.textContent =
                '‚ùå Please choose a place or provide coordinates.';
            errorEl.style.display = 'block';
            return;
        }

        errorEl.style.display = 'none';
        if (hasCoords) {
            persistLocation(
                latInput.value,
                lngInput.value,
                locationInput.value || 'manual coordinates'
            );
        }
    });
})();
</script>
{% endblock %}
